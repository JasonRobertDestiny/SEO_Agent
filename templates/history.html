<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分析历史 - SEO Agent</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/css/modern.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="nav-brand">
                SEO Agent
            </a>
            <ul class="nav-links">
                <li><a href="/" class="nav-link">首页</a></li>
                <li><a href="/batch" class="nav-link">批量处理</a></li>
                <li><a href="/history" class="nav-link active">历史记录</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container">
        <div class="page-header">
            <h1 class="page-title">
                <i class="fas fa-history"></i>
                分析历史
            </h1>
            <p class="page-subtitle">查看和管理您的SEO分析记录</p>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card fade-in">
                <div class="stat-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value">{{ history|length }}</div>
                    <div class="stat-label">总分析次数</div>
                </div>
            </div>
            <div class="stat-card fade-in">
                <div class="stat-icon">
                    <i class="fas fa-star"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="avgScore">--</div>
                    <div class="stat-label">平均评分</div>
                </div>
            </div>
            <div class="stat-card fade-in">
                <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="successCount">--</div>
                    <div class="stat-label">成功分析</div>
                </div>
            </div>
            <div class="stat-card fade-in">
                <div class="stat-icon">
                    <i class="fas fa-globe"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="uniqueDomains">--</div>
                    <div class="stat-label">分析域名</div>
                </div>
            </div>
        </div>

        <!-- Filters Card -->
        <div class="card fade-in">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-filter"></i>
                    筛选和搜索
                </h3>
            </div>
            <div class="card-body">
                <div class="filters-grid">
                    <div class="filter-group">
                        <label class="form-label">
                            <i class="fas fa-search"></i>
                            搜索URL或域名
                        </label>
                        <input type="text" class="form-control" id="searchInput" placeholder="输入关键词搜索...">
                    </div>
                    <div class="filter-group">
                        <label class="form-label">
                            <i class="fas fa-info-circle"></i>
                            状态筛选
                        </label>
                        <select class="form-select" id="statusFilter">
                            <option value="">全部状态</option>
                            <option value="success">成功</option>
                            <option value="error">失败</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="form-label">
                            <i class="fas fa-trophy"></i>
                            评分范围
                        </label>
                        <select class="form-select" id="scoreFilter">
                            <option value="">全部评分</option>
                            <option value="excellent">优秀 (80+)</option>
                            <option value="good">良好 (60-79)</option>
                            <option value="poor">需改进 (<60)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-secondary w-100" onclick="clearFilters()">
                            <i class="fas fa-redo"></i>
                            重置
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-bar fade-in">
            <div class="action-buttons">
                <button id="selectAllBtn" class="btn btn-secondary" onclick="toggleSelectAll()">
                    <i class="fas fa-check-square"></i>
                    全选
                </button>
                <button id="deleteSelectedBtn" class="btn btn-danger" onclick="deleteSelected()" disabled>
                    <i class="fas fa-trash"></i>
                    删除选中
                </button>
                <a href="/" class="btn">
                    <i class="fas fa-plus"></i>
                    新建分析
                </a>
            </div>
        </div>

        {% if history %}
        <!-- History Cards Grid -->
        <div class="history-grid" id="historyGrid">
            {% for record in history %}
            <div class="history-card fade-in" 
                 data-url="{{ record.url|lower }}" 
                 data-status="{{ 'success' if record.status == 'completed' else 'error' }}"
                 data-score="{{ record.seo_score if record.seo_score else 0 }}">
                <div class="card-checkbox">
                    <input type="checkbox" class="delete-checkbox" 
                           value="{{ record.id }}" onchange="updateDeleteButton()">
                </div>
                
                <div class="card-status">
                    {% if record.status == 'completed' %}
                    <div class="status-indicator success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    {% else %}
                    <div class="status-indicator error">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    {% endif %}
                </div>

                <div class="card-content">
                    <div class="card-url" title="{{ record.url }}">
                        {{ record.url }}
                    </div>
                    <div class="card-domain">
                        <i class="fas fa-globe"></i>
                        {{ record.url.split('://')[1].split('/')[0] if '://' in record.url else record.url }}
                    </div>
                    
                    {% if record.status == 'completed' and record.seo_score %}
                    <div class="card-score">
                        <div class="score-circle-small">
                            <div class="score-value-small {% if record.seo_score >= 80 %}score-excellent{% elif record.seo_score >= 60 %}score-good{% else %}score-poor{% endif %}">
                                {{ record.seo_score }}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <div class="card-meta">
                    <div class="card-time">
                        <i class="fas fa-clock"></i>
                        {{ record.timestamp[:10] if record.timestamp else '--' }}
                        {{ record.timestamp[11:16] if record.timestamp and len(record.timestamp) > 16 else '' }}
                    </div>
                </div>

                <div class="card-actions">
                    {% if record.status == 'completed' %}
                    <a href="/report/{{ record.id }}" class="btn-icon" title="查看报告" target="_blank">
                        <i class="fas fa-eye"></i>
                    </a>
                    <a href="/download/{{ record.id }}" class="btn-icon" title="下载报告">
                        <i class="fas fa-download"></i>
                    </a>
                    {% endif %}
                    <button class="btn-icon btn-danger" onclick="deleteRecord('{{ record.id }}')" title="删除记录">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>

        {% else %}
        <!-- Empty State -->
        <div class="empty-state fade-in">
            <div class="empty-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <h3>暂无分析记录</h3>
            <p>您还没有进行过SEO分析，立即开始您的第一次分析吧！</p>
            <a href="/" class="btn">
                <i class="fas fa-rocket"></i>
                开始分析
            </a>
        </div>
        {% endif %}
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            calculateStats();
            initializeFilters();
        });

        // Calculate Statistics
        function calculateStats() {
            const cards = document.querySelectorAll('.history-card');
            let successCount = 0;
            let totalScore = 0;
            let scoreCount = 0;
            const domains = new Set();

            cards.forEach(card => {
                const status = card.dataset.status;
                const score = parseInt(card.dataset.score);
                const url = card.dataset.url;

                if (status === 'success') {
                    successCount++;
                    if (score > 0) {
                        totalScore += score;
                        scoreCount++;
                    }
                }

                // Extract domain
                try {
                    const domain = new URL(url).hostname;
                    domains.add(domain);
                } catch (e) {
                    // Ignore invalid URLs
                }
            });

            // Update stats display
            document.getElementById('avgScore').textContent = scoreCount > 0 ? Math.round(totalScore / scoreCount) : '--';
            document.getElementById('successCount').textContent = successCount;
            document.getElementById('uniqueDomains').textContent = domains.size;
        }

        // Initialize Filters
        function initializeFilters() {
            const searchInput = document.getElementById('searchInput');
            const statusFilter = document.getElementById('statusFilter');
            const scoreFilter = document.getElementById('scoreFilter');

            [searchInput, statusFilter, scoreFilter].forEach(filter => {
                filter.addEventListener('input', applyFilters);
                filter.addEventListener('change', applyFilters);
            });
        }

        // Apply Filters
        function applyFilters() {
            const searchValue = document.getElementById('searchInput').value.toLowerCase();
            const statusValue = document.getElementById('statusFilter').value;
            const scoreValue = document.getElementById('scoreFilter').value;
            
            const cards = document.querySelectorAll('.history-card');
            
            cards.forEach(card => {
                let visible = true;
                
                // Search filter
                if (searchValue) {
                    const url = card.dataset.url;
                    if (!url.includes(searchValue)) {
                        visible = false;
                    }
                }
                
                // Status filter
                if (statusValue) {
                    const status = card.dataset.status;
                    if (status !== statusValue) {
                        visible = false;
                    }
                }
                
                // Score filter
                if (scoreValue) {
                    const score = parseInt(card.dataset.score);
                    switch (scoreValue) {
                        case 'excellent':
                            if (score < 80) visible = false;
                            break;
                        case 'good':
                            if (score < 60 || score >= 80) visible = false;
                            break;
                        case 'poor':
                            if (score >= 60) visible = false;
                            break;
                    }
                }
                
                card.style.display = visible ? '' : 'none';
            });
        }

        // Clear Filters
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('scoreFilter').value = '';
            applyFilters();
        }

        // Toggle Select All
        function toggleSelectAll() {
            const selectAllBtn = document.getElementById('selectAllBtn');
            const checkboxes = document.querySelectorAll('.delete-checkbox');
            const isVisible = selectAllBtn.textContent.includes('全选');
            
            checkboxes.forEach(checkbox => {
                if (checkbox.closest('.history-card').style.display !== 'none') {
                    checkbox.checked = isVisible;
                }
            });
            
            selectAllBtn.innerHTML = isVisible ? 
                '<i class="fas fa-square"></i> 取消全选' : 
                '<i class="fas fa-check-square"></i> 全选';
            
            updateDeleteButton();
        }

        // Update Delete Button
        function updateDeleteButton() {
            const selectedCheckboxes = document.querySelectorAll('.delete-checkbox:checked');
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            
            deleteBtn.disabled = selectedCheckboxes.length === 0;
            deleteBtn.innerHTML = selectedCheckboxes.length > 0 ? 
                `<i class="fas fa-trash"></i> 删除选中 (${selectedCheckboxes.length})` : 
                '<i class="fas fa-trash"></i> 删除选中';
        }

        // Delete Single Record
        async function deleteRecord(recordId) {
            if (!confirm('确定要删除这条分析记录吗？此操作不可恢复！')) {
                return;
            }

            try {
                const response = await fetch(`/delete/${recordId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    showNotification('删除成功', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    const errorData = await response.json();
                    showNotification(`删除失败: ${errorData.detail || '未知错误'}`, 'error');
                }
            } catch (error) {
                console.error('删除失败:', error);
                showNotification('删除失败: 网络错误', 'error');
            }
        }

        // Batch Delete
        async function deleteSelected() {
            const selectedCheckboxes = document.querySelectorAll('.delete-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                showNotification('请先选择要删除的记录', 'warning');
                return;
            }

            if (!confirm(`确定要删除选中的 ${selectedCheckboxes.length} 条记录吗？此操作不可恢复！`)) {
                return;
            }

            const ids = Array.from(selectedCheckboxes).map(checkbox => checkbox.value);

            try {
                const response = await fetch('/delete/batch', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ ids: ids }),
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification(`成功删除 ${result.deleted_count} 条记录`, 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    const errorData = await response.json();
                    showNotification(`删除失败: ${errorData.detail || '未知错误'}`, 'error');
                }
            } catch (error) {
                console.error('批量删除失败:', error);
                showNotification('删除失败: 网络错误', 'error');
            }
        }

        // Show Notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-times-circle' : 'fa-info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }
    </script>

    <style>
        /* History Page Specific Styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-primary);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: white;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 2rem 0;
        }

        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .history-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            position: relative;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .history-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-primary);
        }

        .card-checkbox {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 10;
        }

        .card-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .card-status {
            margin-bottom: 1rem;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .status-indicator.success {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-success);
        }

        .status-indicator.error {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-danger);
        }

        .card-content {
            flex: 1;
            margin-bottom: 1rem;
        }

        .card-url {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            word-break: break-all;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .card-domain {
            color: var(--text-secondary);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-score {
            margin-top: 1rem;
        }

        .score-circle-small {
            display: inline-block;
        }

        .score-value-small {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: 700;
            position: relative;
        }

        .score-value-small::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            padding: 2px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
        }

        .card-meta {
            margin-bottom: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .card-time {
            color: var(--text-secondary);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn-icon:hover {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
            transform: translateY(-1px);
        }

        .btn-icon.btn-danger:hover {
            background: var(--accent-danger);
            border-color: var(--accent-danger);
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
        }

        .empty-icon {
            font-size: 4rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .empty-state p {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .notification-success {
            border-left: 4px solid var(--accent-success);
        }

        .notification-error {
            border-left: 4px solid var(--accent-danger);
        }

        .notification-warning {
            border-left: 4px solid var(--accent-warning);
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .action-bar {
                flex-direction: column;
                gap: 1rem;
            }
            
            .action-buttons {
                width: 100%;
                justify-content: center;
            }
            
            .history-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</body>
</html>