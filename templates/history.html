<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分析历史 - SEO Agent Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/static/style.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-search"></i> SEO Agent Pro
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">网站分析</a>
                <a class="nav-link active" href="/history">分析历史</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-history"></i> 分析历史记录
                        </h4>
                        <div>
                            <button class="btn btn-outline-secondary btn-sm me-2" onclick="exportHistory()">
                                <i class="fas fa-file-export"></i> 导出
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="clearHistory()">
                                <i class="fas fa-trash"></i> 清空历史
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if history %}
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" class="form-control" id="searchInput" placeholder="搜索URL...">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filterSelect">
                                    <option value="">所有记录</option>
                                    <option value="ai">AI分析</option>
                                    <option value="basic">基础分析</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="sortSelect">
                                    <option value="date_desc">最新优先</option>
                                    <option value="date_asc">最早优先</option>
                                    <option value="score_desc">评分从高到低</option>
                                    <option value="score_asc">评分从低到高</option>
                                </select>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover" id="historyTable">
                                <thead>
                                    <tr>
                                        <th>网站URL</th>
                                        <th>分析时间</th>
                                        <th>综合评分</th>
                                        <th>分析类型</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in history %}
                                    <tr data-url="{{ item.url }}" data-type="{% if item.use_ai %}ai{% else %}basic{% endif %}" data-score="{{ item.seo_score }}" data-date="{{ item.timestamp }}">
                                        <td>
                                            <a href="{{ item.url }}" target="_blank" class="text-decoration-none">
                                                {{ item.url|truncate(50, true) }}
                                            </a>
                                        </td>
                                        <td>{{ item.timestamp }}</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="progress me-2" style="width: 60px; height: 8px;">
                                                    <div class="progress-bar {% if item.seo_score >= 80 %}bg-success{% elif item.seo_score >= 60 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                         data-score="{{ item.seo_score }}"></div>
                                                </div>
                                                <span class="badge {% if item.seo_score >= 80 %}bg-success{% elif item.seo_score >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                                                    {{ item.seo_score }}
                                                </span>
                                            </div>
                                        </td>
                                        <td>
                                            {% if item.use_ai %}
                                                <span class="badge bg-info"><i class="fas fa-robot"></i> AI分析</span>
                                            {% else %}
                                                <span class="badge bg-secondary"><i class="fas fa-cog"></i> 基础</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="/view_report/{{ item.id }}" class="btn btn-outline-primary" target="_blank">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <a href="/download_report/{{ item.id }}" class="btn btn-outline-success">
                                                    <i class="fas fa-download"></i>
                                                </a>
                                                <button class="btn btn-outline-danger" onclick="deleteRecord('{{ item.id }}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div>
                                共 <span class="badge bg-primary">{{ history|length }}</span> 条记录
                            </div>
                            <nav>
                                <ul class="pagination pagination-sm mb-0">
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" tabindex="-1">上一页</a>
                                    </li>
                                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                                    <li class="page-item">
                                        <a class="page-link" href="#">下一页</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">暂无分析记录</h5>
                            <p class="text-muted">开始您的第一次SEO分析吧！</p>
                            <a href="/" class="btn btn-primary">
                                <i class="fas fa-plus"></i> 开始分析
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 动态设置进度条宽度
        document.addEventListener('DOMContentLoaded', function() {
            const progressBars = document.querySelectorAll('.progress-bar');
            progressBars.forEach(bar => {
                const score = bar.getAttribute('data-score');
                if (score) {
                    bar.style.width = score + '%';
                }
            });
        });

        // 搜索功能
        document.getElementById('searchInput').addEventListener('keyup', function() {
            filterTable();
        });

        // 过滤功能
        document.getElementById('filterSelect').addEventListener('change', function() {
            filterTable();
        });

        // 排序功能
        document.getElementById('sortSelect').addEventListener('change', function() {
            sortTable();
        });

        function filterTable() {
            const searchValue = document.getElementById('searchInput').value.toLowerCase();
            const filterValue = document.getElementById('filterSelect').value;
            const rows = document.querySelectorAll('#historyTable tbody tr');

            rows.forEach(row => {
                const url = row.getAttribute('data-url').toLowerCase();
                const type = row.getAttribute('data-type');
                
                const matchSearch = url.includes(searchValue);
                const matchFilter = !filterValue || type === filterValue;
                
                row.style.display = matchSearch && matchFilter ? '' : 'none';
            });
        }

        function sortTable() {
            const sortValue = document.getElementById('sortSelect').value;
            const tbody = document.querySelector('#historyTable tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            rows.sort((a, b) => {
                switch(sortValue) {
                    case 'date_desc':
                        return new Date(b.getAttribute('data-date')) - new Date(a.getAttribute('data-date'));
                    case 'date_asc':
                        return new Date(a.getAttribute('data-date')) - new Date(b.getAttribute('data-date'));
                    case 'score_desc':
                        return parseInt(b.getAttribute('data-score')) - parseInt(a.getAttribute('data-score'));
                    case 'score_asc':
                        return parseInt(a.getAttribute('data-score')) - parseInt(b.getAttribute('data-score'));
                    default:
                        return 0;
                }
            });

            rows.forEach(row => tbody.appendChild(row));
        }

        function clearHistory() {
            if (confirm('确定要清空所有历史记录吗？此操作不可恢复。')) {
                fetch('/clear_history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('清空失败：' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('清空失败');
                });
            }
        }

        function deleteRecord(id) {
            if (confirm('确定要删除这条记录吗？')) {
                fetch('/delete_record/' + id, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('删除失败：' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('删除失败');
                });
            }
        }

        function exportHistory() {
            // 创建CSV内容
            let csv = 'URL,分析时间,综合评分,分析类型\n';
            const rows = document.querySelectorAll('#historyTable tbody tr');
            
            rows.forEach(row => {
                const url = row.getAttribute('data-url');
                const date = row.getAttribute('data-date');
                const score = row.getAttribute('data-score');
                const type = row.getAttribute('data-type') === 'ai' ? 'AI分析' : '基础分析';
                
                csv += `"${url}",${date},${score},"${type}"\n`;
            });

            // 下载CSV文件
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'seo_analysis_history_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
        }
    </script>
</body>
</html>